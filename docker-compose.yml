version: '3.8'

services:
  # -----------------------------------------------------------------------------
  # Zookeeper - Required for Kafka
  # -----------------------------------------------------------------------------
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - csv-network
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181", "|", "imok"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -----------------------------------------------------------------------------
  # Kafka - Event Queue for decoupling services
  # -----------------------------------------------------------------------------
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
    networks:
      - csv-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "kafka:29092"]
      interval: 10s
      timeout: 10s
      retries: 10

  # -----------------------------------------------------------------------------
  # API Gateway - Single entry point for all clients
  # -----------------------------------------------------------------------------
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    ports:
      - "8080:8080"
    depends_on:
      kafka:
        condition: service_healthy
      upload-service:
        condition: service_started
      download-service:
        condition: service_started
    networks:
      - csv-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # -----------------------------------------------------------------------------
  # Common JobStore Service - Centralized in-memory job status store
  # -----------------------------------------------------------------------------
  common-jobstore-service:
    build:
      context: .
      dockerfile: common-jobstore-service/Dockerfile
    ports:
      - "8084:8084"
    networks:
      - csv-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # -----------------------------------------------------------------------------
  # Upload Service - Handles CSV file uploads
  # -----------------------------------------------------------------------------
  upload-service:
    build:
      context: .
      dockerfile: upload-service/Dockerfile
    ports:
      - "8081:8081"
    volumes:
      - csv-data:/data
    depends_on:
      kafka:
        condition: service_healthy
      common-jobstore-service:
        condition: service_started
    networks:
      - csv-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # -----------------------------------------------------------------------------
  # Worker Service - Batch processes CSV files
  # -----------------------------------------------------------------------------
  worker-service:
    build:
      context: .
      dockerfile: worker-service/Dockerfile
    volumes:
      - csv-data:/data
    depends_on:
      kafka:
        condition: service_healthy
      common-jobstore-service:
        condition: service_started
    networks:
      - csv-network
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # -----------------------------------------------------------------------------
  # Download Service - Streams processed CSV files
  # -----------------------------------------------------------------------------
  download-service:
    build:
      context: .
      dockerfile: download-service/Dockerfile
    ports:
      - "8083:8083"
    volumes:
      - csv-data:/data
    depends_on:
      kafka:
        condition: service_healthy
      common-jobstore-service:
        condition: service_started
    networks:
      - csv-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# -----------------------------------------------------------------------------
# Shared Volumes (simulating S3/shared storage)
# -----------------------------------------------------------------------------
volumes:
  csv-data:
    driver: local

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  csv-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
